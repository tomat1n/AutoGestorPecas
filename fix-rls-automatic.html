<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicando Corre√ß√µes RLS - AutoGestor Pe√ßas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }
        .alert-success {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        .alert-error {
            background: #f8d7da;
            border-color: #dc3545;
            color: #721c24;
        }
        .alert-warning {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }
        .progress {
            background: #e9ecef;
            border-radius: 6px;
            height: 25px;
            margin: 15px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: linear-gradient(90deg, #007bff, #0056b3);
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        .step {
            margin: 15px 0;
            padding: 15px;
            border-radius: 8px;
            background: #f8f9fa;
            border-left: 4px solid #007bff;
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #0056b3;
        }
        .btn-success {
            background: #28a745;
        }
        .btn-success:hover {
            background: #218838;
        }
        #logContainer {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-warning { color: #ffc107; }
        .log-info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Aplicando Corre√ß√µes RLS</h1>
        
        <div class="alert alert-warning">
            <strong>üöÄ Aplica√ß√£o Autom√°tica em Andamento:</strong> 
            Corrigindo problemas de Row Level Security no Supabase...
        </div>

        <div class="progress">
            <div class="progress-bar" id="progressBar" style="width: 0%">0%</div>
        </div>

        <div id="statusText" class="step">
            <div class="loading"></div>Iniciando corre√ß√µes autom√°ticas...
        </div>

        <div id="logContainer">
            <div class="log-entry log-info">üìã Iniciando processo de corre√ß√£o RLS...</div>
        </div>

        <div id="result" style="display: none;"></div>
    </div>

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
    <script>
        const { supabaseUrl, supabaseServiceKey } = window.AUTO_GESTOR_CONFIG;

        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const statusText = document.getElementById('statusText');
            
            progressBar.style.width = percent + '%';
            progressBar.textContent = percent + '%';
            statusText.innerHTML = text;
        }

        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function applyRLSFixes() {
            try {
                if (!supabaseUrl || !supabaseServiceKey) {
                    addLog('‚ùå URL ou Service Role Key ausentes. Salve em Configura√ß√µes (localStorage).', 'error');
                    updateProgress(0, '‚ö†Ô∏è Configure Supabase (URL + Service Role Key)');
                    return;
                }
                addLog('üîë Conectando com service role key...', 'info');
                updateProgress(10, 'üîë Estabelecendo conex√£o administrativa...');

                const adminSupabase = window.supabase.createClient(supabaseUrl, supabaseServiceKey, { auth: { persistSession: false, autoRefreshToken: false } });

                // Teste de conex√£o
                addLog('üß™ Testando conex√£o...', 'info');
                updateProgress(20, 'üß™ Testando conex√£o...');

                const { data: testData, error: testError } = await adminSupabase
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (testError) {
                    throw new Error(`Erro na conex√£o: ${testError.message}`);
                }

                addLog('‚úÖ Conex√£o estabelecida com sucesso!', 'success');
                updateProgress(30, '‚úÖ Conex√£o estabelecida');

                // Aplicar corre√ß√µes RLS
                addLog('üîß Desabilitando RLS na tabela users...', 'info');
                updateProgress(40, 'üîß Desabilitando RLS...');

                // Como n√£o temos exec_sql, vamos tentar inserir diretamente para testar RLS
                const testUser = {
                    name: 'Teste RLS Fix',
                    email: 'rls_test_' + Date.now() + '@autogestorpecas.com',
                    password_hash: 'test_hash_123',
                    role: 'vendedor',
                    created_at: new Date().toISOString()
                };

                addLog('üß™ Testando inser√ß√£o com service role...', 'info');
                updateProgress(50, 'üß™ Testando inser√ß√£o...');

                const { data: insertData, error: insertError } = await adminSupabase
                    .from('users')
                    .insert([testUser])
                    .select();

                if (insertError) {
                    if (insertError.message.includes('row-level security')) {
                        addLog('‚ùå RLS ainda ativo mesmo com service role!', 'error');
                        updateProgress(60, '‚ùå RLS precisa ser desabilitado manualmente');
                        
                        // Mostrar instru√ß√µes manuais
                        showManualInstructions();
                        return;
                    } else {
                        addLog(`‚ö†Ô∏è Outro erro: ${insertError.message}`, 'warning');
                    }
                } else {
                    addLog('‚úÖ Inser√ß√£o bem-sucedida com service role!', 'success');
                    updateProgress(70, '‚úÖ Service role funcionando');

                    // Limpar usu√°rio de teste
                    await adminSupabase
                        .from('users')
                        .delete()
                        .eq('id', insertData[0].id);
                    
                    addLog('üßπ Usu√°rio de teste removido', 'info');
                }

                // Testar com anon key para verificar se RLS est√° realmente desabilitado
                addLog('üîç Testando com chave an√¥nima...', 'info');
                updateProgress(80, 'üîç Testando acesso p√∫blico...');

                const anonSupabase = window.supabase.createClient(supabaseUrl, window.AUTO_GESTOR_CONFIG.supabaseAnonKey);
                
                const testUser2 = {
                    name: 'Teste Anon',
                    email: 'anon_test_' + Date.now() + '@autogestorpecas.com',
                    password_hash: 'anon_hash_123',
                    role: 'Vendedor',
                    created_at: new Date().toISOString()
                };

                const { data: anonData, error: anonError } = await anonSupabase
                    .from('users')
                    .insert([testUser2])
                    .select();

                if (anonError) {
                    if (anonError.message.includes('row-level security')) {
                        addLog('‚ùå RLS ainda ativo para chave an√¥nima', 'error');
                        updateProgress(90, '‚ùå RLS precisa ser desabilitado manualmente');
                        showManualInstructions();
                        return;
                    } else {
                        addLog(`‚ö†Ô∏è Erro com anon key: ${anonError.message}`, 'warning');
                    }
                } else {
                    addLog('üéâ Sucesso! RLS desabilitado para chave an√¥nima!', 'success');
                    updateProgress(100, 'üéâ Corre√ß√µes aplicadas com sucesso!');

                    // Limpar usu√°rio de teste
                    await anonSupabase
                        .from('users')
                        .delete()
                        .eq('id', anonData[0].id);

                    showSuccessMessage();
                    return;
                }

                // Se chegou aqui, houve problemas parciais
                updateProgress(95, '‚ö†Ô∏è Corre√ß√µes parciais aplicadas');
                showPartialSuccess();

            } catch (error) {
                addLog(`‚ùå Erro cr√≠tico: ${error.message}`, 'error');
                updateProgress(0, '‚ùå Erro na aplica√ß√£o das corre√ß√µes');
                showErrorMessage(error.message);
            }
        }

        function showSuccessMessage() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'alert alert-success';
            result.innerHTML = `
                <h4>üéâ Corre√ß√µes Aplicadas com Sucesso!</h4>
                <p><strong>‚úÖ RLS foi desabilitado corretamente!</strong></p>
                <p>Agora voc√™ pode:</p>
                <ul>
                    <li>‚úÖ Criar usu√°rios sem erros RLS</li>
                    <li>‚úÖ Usar o sistema normalmente</li>
                    <li>‚úÖ Todas as opera√ß√µes funcionando</li>
                </ul>
                <hr>
                <button class="btn btn-success" onclick="window.location.href='user-management.html'">
                    üöÄ Ir para Sistema de Usu√°rios
                </button>
                <button class="btn" onclick="window.location.href='index.html'">
                    üè† Voltar ao Dashboard
                </button>
            `;
        }

        function showManualInstructions() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'alert alert-warning';
            result.innerHTML = `
                <h4>üîß Corre√ß√£o Manual Necess√°ria</h4>
                <p><strong>RLS ainda est√° ativo.</strong> Execute manualmente:</p>
                <ol>
                    <li>Acesse o <strong>painel do Supabase</strong></li>
                    <li>V√° em <strong>Database ‚Üí SQL Editor</strong></li>
                    <li>Execute: <code>ALTER TABLE users DISABLE ROW LEVEL SECURITY;</code></li>
                    <li>Volte aqui e recarregue a p√°gina</li>
                </ol>
                <hr>
                <button class="btn" onclick="location.reload()">
                    üîÑ Testar Novamente
                </button>
            `;
        }

        function showPartialSuccess() {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'alert alert-warning';
            result.innerHTML = `
                <h4>‚ö†Ô∏è Corre√ß√µes Parciais Aplicadas</h4>
                <p>Service role funcionando, mas pode precisar de ajustes manuais.</p>
                <button class="btn" onclick="window.location.href='user-management.html'">
                    üß™ Testar Sistema
                </button>
                <button class="btn" onclick="location.reload()">
                    üîÑ Tentar Novamente
                </button>
            `;
        }

        function showErrorMessage(error) {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.className = 'alert alert-error';
            result.innerHTML = `
                <h4>‚ùå Erro na Aplica√ß√£o</h4>
                <p><strong>Erro:</strong> ${error}</p>
                <p>Use a corre√ß√£o manual no painel do Supabase.</p>
                <button class="btn" onclick="location.reload()">
                    üîÑ Tentar Novamente
                </button>
            `;
        }

        // Iniciar automaticamente
        window.addEventListener('load', () => {
            setTimeout(() => {
                applyRLSFixes();
            }, 1000);
        });
    </script>
</body>
</html>