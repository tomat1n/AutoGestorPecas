<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Desabilitar RLS - AutoGestor Pe√ßas</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="config.js"></script>
</head>
<body>
    <h1>üîß Desabilitar RLS - Solu√ß√£o Definitiva</h1>
    <p>Este script vai desabilitar o RLS (Row Level Security) nas tabelas necess√°rias.</p>
    
    <button onclick="disableRLS()" style="background: #e74c3c; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
        üöÄ Desabilitar RLS Agora
    </button>
    
    <div id="result" style="margin-top: 20px; padding: 15px; border-radius: 5px;"></div>

    <script>
        async function disableRLS() {
            const resultDiv = document.getElementById('result');
            resultDiv.style.background = '#f8f9fa';
            resultDiv.innerHTML = '<p>üîÑ Desabilitando RLS...</p>';
            
            try {
                const supabase = window.supabase.createClient(
                    window.AUTO_GESTOR_CONFIG.supabaseUrl,
                    window.AUTO_GESTOR_CONFIG.supabaseAnonKey
                );

                // SQL para desabilitar RLS
                const disableRLSSQL = `
                    ALTER TABLE users DISABLE ROW LEVEL SECURITY;
                    ALTER TABLE user_activity_log DISABLE ROW LEVEL SECURITY;
                    ALTER TABLE user_sessions DISABLE ROW LEVEL SECURITY;
                `;

                resultDiv.innerHTML += '<p>üìù Executando comandos SQL...</p>';

                // Tentar via RPC primeiro
                try {
                    const { data, error } = await supabase.rpc('exec_sql', { 
                        sql: disableRLSSQL 
                    });
                    
                    if (error) {
                        throw new Error(`RPC Error: ${error.message}`);
                    }
                    
                    resultDiv.style.background = '#d4edda';
                    resultDiv.innerHTML = '<p style="color: #155724;">‚úÖ <strong>RLS DESABILITADO COM SUCESSO!</strong></p>';
                    resultDiv.innerHTML += '<p>Agora voc√™ pode criar usu√°rios normalmente.</p>';
                    resultDiv.innerHTML += '<p><a href="user-management.html" style="color: #007bff;">üîó Voltar para Gerenciamento de Usu√°rios</a></p>';
                    
                } catch (rpcError) {
                    console.log('RPC falhou:', rpcError.message);
                    
                    // Tentar abordagem alternativa - executar comandos individualmente
                    resultDiv.innerHTML += '<p>‚ö†Ô∏è RPC n√£o dispon√≠vel. Tentando abordagem alternativa...</p>';
                    
                    const commands = [
                        'ALTER TABLE users DISABLE ROW LEVEL SECURITY;',
                        'ALTER TABLE user_activity_log DISABLE ROW LEVEL SECURITY;',
                        'ALTER TABLE user_sessions DISABLE ROW LEVEL SECURITY;'
                    ];
                    
                    let success = false;
                    for (const cmd of commands) {
                        try {
                            await supabase.rpc('exec_sql', { sql: cmd });
                            resultDiv.innerHTML += `<p>‚úÖ ${cmd}</p>`;
                            success = true;
                        } catch (cmdError) {
                            resultDiv.innerHTML += `<p>‚ùå ${cmd} - ${cmdError.message}</p>`;
                        }
                    }
                    
                    if (success) {
                        resultDiv.style.background = '#d4edda';
                        resultDiv.innerHTML += '<p style="color: #155724;"><strong>‚úÖ RLS PARCIALMENTE DESABILITADO!</strong></p>';
                        resultDiv.innerHTML += '<p>Tente criar um usu√°rio agora.</p>';
                    } else {
                        // Solu√ß√£o manual necess√°ria
                        resultDiv.style.background = '#f8d7da';
                        resultDiv.innerHTML = '<p style="color: #721c24;"><strong>‚ùå SOLU√á√ÉO MANUAL NECESS√ÅRIA</strong></p>';
                        resultDiv.innerHTML += '<p><strong>Siga estes passos:</strong></p>';
                        resultDiv.innerHTML += '<ol>';
                        resultDiv.innerHTML += '<li>Acesse o <a href="https://supabase.com/dashboard" target="_blank">painel do Supabase</a></li>';
                        resultDiv.innerHTML += '<li>V√° em <strong>Database > Tables > users</strong></li>';
                        resultDiv.innerHTML += '<li>Clique em <strong>"RLS disabled"</strong> ou v√° em <strong>SQL Editor</strong></li>';
                        resultDiv.innerHTML += '<li>Execute este comando:</li>';
                        resultDiv.innerHTML += '</ol>';
                        resultDiv.innerHTML += '<pre style="background: #f1f1f1; padding: 10px; border-radius: 3px;">ALTER TABLE users DISABLE ROW LEVEL SECURITY;</pre>';
                        resultDiv.innerHTML += '<p>Depois tente criar o usu√°rio novamente.</p>';
                    }
                }
                
            } catch (error) {
                console.error('Erro:', error);
                resultDiv.style.background = '#f8d7da';
                resultDiv.innerHTML = `<p style="color: #721c24;">‚ùå <strong>Erro:</strong> ${error.message}</p>`;
                resultDiv.innerHTML += '<p>Ser√° necess√°rio desabilitar RLS manualmente no painel do Supabase.</p>';
            }
        }

        // Executar automaticamente ap√≥s 1 segundo
        window.onload = () => {
            setTimeout(() => {
                document.querySelector('button').click();
            }, 1000);
        };
    </script>
</body>
</html>